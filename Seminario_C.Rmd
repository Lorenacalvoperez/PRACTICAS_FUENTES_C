---
title: "Depresión y Jubilación"
author: "Lorena Calvo Pérez, Julia Arellano Atienza, Mario Díaz Sutil"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción
 En este seminario ,se va a estudiar la relación que hay entre la necesidad de atención psicológica que proximamente definiremos , la temperatura y salario.

## Objetivos
 Inicialmente, se han planteado una serie de objetivos, de los cuales que tras el análisis de los datos obtendremos respuestas:
 
  - Visualizar la necesidad de atención psicológica por Comunidades Autónomas
  - Estudiar como afecta la temperatura sobre la necesidad de atención psicológica 
  - Estudiar como afecta  el salario sobre la necesidad de atención psicológica 
  
## Información sobre el tema

 
# Materiales y Métodos
 
## Carga de librerías
```{r}
library(climaemet)
library(tibble)
library(tidyverse)
library(rjson)
library(tidyjson)
library(readr)
library(ggplot2)
library(mapSpain)
library(sf)
library(cowplot)
library(visreg)
library(DT)
```
## Carga de datos
### Carga de datos de climaemet
```{r}
# Obtención de las Tª diaras por estaciones aemet:

observaciones_diarias <-aemet_daily_period_all(start = 2021, end = 2022)
```

### Carga de datos JSON
```{r eval=FALSE}

#Carga de datos de la población json no coindiden los atributos 

poblacion_json <- fromJSON(file ="DATA/poblacion.json")

poblacion_json %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

poblacion_Data<- poblacion_json %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() 
 

poblacion_MetaData<- poblacion_json %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all()

poblacion_json_union<- cbind(poblacion_Metadata,poblacion_Data)

#CARGA de datos psicologos.json 

psicologos_json_2021 <- fromJSON(file ="DATA/tasa_psicologos_2021.json")

#Identificacion de arrays

psicologos_json_2021 %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

#obtenemos la columna data

psicologos_json_2021_Data<- psicologos_json_2021 %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(Valor)

#obtenemos la columna metadata

psicologos_json_2021_Metadata<- psicologos_json_2021 %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(-document.id, - array.index)

#union de columnas

psicologos_json_2021_union<- cbind(psicologos_json_2021_Metadata,psicologos_json_2021_Data)


```

### Carga de datos csv
```{r}
# Carga csv de psicologos

psicologos_2021 <- read_delim("DATA/psicologos2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


psicologos_2022 <- read_delim("DATA/psicologos2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga csv de visitas

visitas_2021 <- read_delim("DATA/visitas_2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

visitas_2022 <- read_delim("DATA/visitas_2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga de datos Población.csv

poblacion <- read_delim("DATA/poblacion_CA_años.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


# Carga de datos de salarios .csv:

salarios <- read_delim("DATA/salarios_CCAA.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

## Trabajando con los datos

### Obtención de la Temperatura Media

```{r}

# Temperatura de las provincias
temp_provincias <-  observaciones_diarias %>%
  mutate(years=lubridate::year(fecha))%>%
  group_by (years,provincia) %>%
  summarise(
    tmedia = mean(tmed, na.rm = TRUE)
  )

# Creacion de una columna con las comunidades autonomas
  temp_con_CCAA <- temp_provincias %>%
  mutate(CCAA = case_when(
    provincia %in% c("BURGOS", "AVILA", "LEON", "SALAMANCA", "SEGOVIA", "SORIA", "VALLADOLID" ,"PALENCIA" ,"ZAMORA") ~ "CASTILLA Y LEON",
    provincia %in% c("ALBACETE", "CIUDAD REAL", "CUENCA", "GUADALAJARA", "TOLEDO") ~ "CASTILLA-LA MANCHA",
    provincia %in% c("ALMERIA", "CADIZ", "CORDOBA", "GRANADA", "HUELVA", "JAEN", "MALAGA", "SEVILLA") ~ "ANDALUCIA",
    provincia %in% c("HUESCA", "ZARAGOZA", "TERUEL") ~ "ARAGON",
    provincia == "ASTURIAS" ~ "ASTURIAS",
    provincia == "CANTABRIA" ~ "CANTABRIA",
    provincia == "ILLES BALEARS" ~ "BALEARES",
    provincia %in% c("STA. CRUZ DE TENERIFE", "LAS PALMAS") ~ "CANARIAS",
    provincia == "LA RIOJA" ~ "LA RIOJA",
    provincia %in% c("ARABA/ALAVA", "GIPUZKOA", "BIZKAIA") ~ "PAIS VASCO",
    provincia %in% c("BARCELONA", "GIRONA", "LLEIDA", "TARRAGONA") ~ "CATALUÑA", 
    provincia %in% c("ALICANTE", "CASTELLON", "VALENCIA") ~ "COMUNIDAD VALENCIANA",
    provincia %in% c("BADAJOZ", "CACERES") ~ "EXTREMADURA",
    provincia %in% c("A CORUÑA", "LUGO", "OURENSE", "PONTEVEDRA") ~ "GALICIA", 
    provincia == "MADRID" ~ "COMUNIDAD DE MADRID",
    provincia == "MURCIA" ~ "MURCIA",
    provincia == "NAVARRA" ~ "NAVARRA",
    provincia == "CEUTA" ~ "CEUTA",
    provincia == "MELILLA" ~ "MELILLA",
    
  ))

# TABLA FINAL Tª
tmed_CCAA<- temp_con_CCAA %>% 
  group_by(CCAA,years) %>% 
  summarise(
  tmedia = mean(tmedia, na.rm = TRUE)) %>% 
  arrange(years)

datatable(tmed_CCAA)
  
```
*Nota:* Temperatura media por Comunidades Autónomas


Para la obtención de la *temperatura media*, se han crearon una columna de años y y otra columna de comunidades.Esta última se utilizó para agrupar los datos mostrados en provincias en comunidades.
Tras ello, hemos calculado la temperatura media por comunidad. 



### Obtención de los psicólogos

```{r}

psicologos_2021 <- psicologos_2021 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                               levels = c("01 Andalucía", "02 Aragón", 
                                          "03 Asturias, Principado de", "04 Balears, Illes", 
                                          "05 Canarias", 
                                          "06 Cantabria", 
                                          "07 Castilla y León", "08 Castilla - La Mancha",
                                          "09 Cataluña", "10 Comunitat Valenciana",
                                          "11 Extremadura", "12 Galicia", 
                                          "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                          "15 Navarra, Comunidad Foral de",
                                          "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                          "19 Melilla"), 
                               labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA")))



psicologos_2022 <- psicologos_2022 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                       levels = c("Andalucía", "Aragón", 
                                                  "Asturias, Principado de", "Balears, Illes", 
                                                  "Canarias", 
                                                  "Cantabria", 
                                                  "Castilla-La Mancha", "Castilla y León",
                                                  "Cataluña", "Ceuta", "Comunidad Valenciana",
                                                  "Extremadura", "Galicia", 
                                                  "Madrid, Comunidad de", "Melilla", "Murcia, Región de",
                                                  "Navarra, Comunidad Foral de",
                                                  "País Vasco", "Rioja, La" 
                                                  ), 
                                       labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                  "BALEARES", "CANARIAS", "CANTABRIA", 
                                                  "CASTILLA-LA MANCHA", "CASTILLA Y LEON", "CATALUÑA", 
                                                  "CEUTA", "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                  "GALICIA", "COMUNIDAD DE MADRID", "MELILLA", "MURCIA",
                                                  "NAVARRA", "PAIS VASCO", "LA RIOJA")))


# Psicologos completos

psicologos <- psicologos_2021 %>%
  mutate(years = 2021) %>% 
  full_join(., 
            psicologos_2022 %>%
              mutate(years = 2022) ) %>% 
  drop_na() %>% 
  filter(`Situación laboral`== "Colegiados no jubilados") %>% 
  group_by(CCAA, years) %>%
  mutate(Total_ind_ps=Total/10^5) %>%
  select(Total_ind_ps)
# La columan de Total_ps está en formato numérico 

datatable(psicologos)

```
*Nota:* Nº de psicólogos por Comunidades Autónomas

Los datos de *psicólogos* utilizados se encontraban en distintos conjuntos de datos.Inicialmente, se creo una columna CCAA en cada uno de los conjuntos para estandarizar los nombres de las comunidades autónomas.
Tras ello, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

### Obtención de las visitas
```{r}
visitas_2021 <- visitas_2021 %>% 
  mutate(Total_v = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))

visitas_2022 <- visitas_2022 %>% 
  mutate(Total_v = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))


levels(factor(visitas_2021$`Comunidades y Ciudades Autónomas`))
levels(factor(visitas_2022$`Comunidades y Ciudades Autónomas`))

visitas_2021 <- visitas_2021 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                                     levels = c("Andalucía", "Aragón", 
                                                                "Asturias (Principado de)", "Balears (Illes)", 
                                                                "Canarias", 
                                                                "Cantabria", 
                                                                "Castilla-La Mancha", "Castilla y León",
                                                                "Cataluña", "Ceuta (Ciudad Autónoma de)", 
                                                                "Comunitat Valenciana",
                                                                "Extremadura", "Galicia", 
                                                                "Madrid (Comunidad de)", 
                                                                "Melilla (Ciudad Autónoma de)", "Murcia (Región de)",
                                                                "Navarra (Comunidad Foral de)",
                                                                "País Vasco", "Rioja (La)" 
                                                     ), 
                                                     labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                                "BALEARES", "CANARIAS", "CANTABRIA", 
                                                                "CASTILLA-LA MANCHA", "CASTILLA Y LEON", "CATALUÑA", 
                                                                "CEUTA", "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                                "GALICIA", "COMUNIDAD DE MADRID", "MELILLA", "MURCIA",
                                                                "NAVARRA", "PAIS VASCO", "LA RIOJA")))


visitas_2022 <- visitas_2022 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                             levels = c("01 Andalucía", "02 Aragón", 
                                        "03 Asturias, Principado de", "04 Balears, Illes", 
                                        "05 Canarias", 
                                        "06 Cantabria", 
                                        "07 Castilla y León", "08 Castilla - La Mancha",
                                        "09 Cataluña", "10 Comunitat Valenciana",
                                        "11 Extremadura", "12 Galicia", 
                                        "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                        "15 Navarra, Comunidad Foral de",
                                        "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                        "19 Melilla"), 
                             labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                        "BALEARES", "CANARIAS", "CANTABRIA", 
                                        "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                        "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                        "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                        "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA")))

#Visitas finales
visitas<- visitas_2021%>%
  mutate(years = 2021) %>% 
  full_join(., 
            visitas_2022%>%
              mutate(years = 2022) ) %>% 
  drop_na() %>% 
  filter(`Tipo de profesional` == "Psicólogo, psicoterapeuta o psiquiatra" & 
           `Sí o no` == "Sí" & Sexo == "Ambos sexos") %>% 
  group_by(CCAA, years) %>% 
  select(Total_v)

datatable(visitas)

```
*Nota:* Nº de visitas por Comunidades Autónomas

Los datos de *visitas* utilizados se encontraban en distintos conjuntos de datos.Inicialmente, se creo una columna CCAA en cada uno de los conjuntos para estandarizar los nombres de las comunidades autónomas.
Tras ello, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

### Obtención del salario
```{r}
salarios <- salarios %>% 
  mutate(Total_s = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))


# Es necesario aplicar un mutate sobre salarios para que tenga los mismos levels que el resto de tablas
salarios <- salarios %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autonómas`, 
                                                 levels = c("01 Andalucía", "02 Aragón", 
                                                            "03 Asturias, Principado de", "04 Balears, Illes", 
                                                            "05 Canarias", 
                                                            "06 Cantabria", 
                                                            "07 Castilla y León", "08 Castilla - La Mancha",
                                                            "09 Cataluña", "10 Comunitat Valenciana",
                                                            "11 Extremadura", "12 Galicia", 
                                                            "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                                            "15 Navarra, Comunidad Foral de",
                                                            "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                                            "19 Melilla", "Total Nacional"), 
                                                 labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                            "BALEARES", "CANARIAS", "CANTABRIA", 
                                                            "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                                            "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                            "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                                            "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA",
                                                            "TOTAL NACIONAL")))

levels(factor(salarios$CCAA))

# Salarios completos

salarios_final <- salarios %>%
  drop_na() %>% 
  rename(years = Periodo)%>% 
  filter(`Tipo de jornada` == "Total" & 
           Decil == "Total decil" &
           years %in% c(2021,2022) &
           CCAA != "TOTAL NACIONAL" ) %>% 
  group_by(CCAA, years) %>% 
  select(Total_s) %>% 
  arrange(years)

datatable(salarios_final)
```
*Nota:* Salarios mensuales por Comunidades Autónomas

Para la obtención de los datos de *salario* utilizados.Se crean una columna para transformar los salarios de tipo __character__ a tipo __númerico__.
Tras ello, se creo una columna CCAA para estandarizar los nombres de las comunidades autónomas.Además, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

### Obtención de la población
```{r}
poblacion <- poblacion %>% 
  mutate(Total_pob = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))



# Es necesario aplicar un mutate sobre poblacion para que tenga los mismos levels que el resto de tablas: 
poblacion <- poblacion %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                               levels = c("01 Andalucía", "02 Aragón", 
                                                          "03 Asturias, Principado de", "04 Balears, Illes", 
                                                          "05 Canarias", 
                                                          "06 Cantabria", 
                                                          "07 Castilla y León", "08 Castilla - La Mancha",
                                                          "09 Cataluña", "10 Comunitat Valenciana",
                                                          "11 Extremadura", "12 Galicia", 
                                                          "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                                          "15 Navarra, Comunidad Foral de",
                                                          "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                                          "19 Melilla", "Total Nacional"), 
                                               labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA",
                                                          "TOTAL NACIONAL")))


#Población completa

poblacion_final <- poblacion %>%
  drop_na() %>% 
  rename(years=Periodo)%>% 
  filter(Sexo == "Ambos sexos" & 
           Nacionalidad == "Total" &
           years %in% c(2021,2022) &
           CCAA != "TOTAL NACIONAL" ) %>% 
  group_by(CCAA,years) %>% 
  select(Total_pob) %>% 
  arrange(years)

datatable(poblacion_final)
```
*Nota:* Población por Comunidades Autónomas

Para la obtención de los datos de *población * utilizados.Se crean una columna para transformar la población de tipo __character__ a tipo __númerico__.
Tras ello, se creo una columna CCAA para estandarizar los nombres de las comunidades autónomas.Además, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

## Obtención de la tabla final

#Análisis de nuestros datos

## Comportamiento de los factores que analizaremos

### Temperatura por comunidades autónomas

```{r}

Temperatura_2021 <- tabla_final %>% 
  filter(years == 2021) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      ))) %>% 
  mutate(., tmedia = round(tmedia, 3))


CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Temperatura_2021, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

X11()
Temperatura_21_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = tmedia),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = tmedia),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Oranges", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$tmedia), 20),
    guide = guide_legend(title = "Temperatura 2021")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))

#Temperatura 2022


Temperatura_2022 <- tabla_final %>% 
  filter(years == 2022) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      ))) %>% 
  mutate(., tmedia = round(tmedia, 3))

CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Temperatura_2022, by = "ccaa.shortname.es")
Can <- esp_get_can_box()
X11()
Temperatura_22_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = tmedia),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = tmedia),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Reds", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$tmedia), 20),
    guide = guide_legend(title = "Temperatura 2022")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))


# Combinación de gráficos:

Temperatura_21_22 <- plot_grid(Temperatura_21_graf, Temperatura_22_graf, ncols = 2, labels = c("TEMPERATURA 2021", "TEMPERATURA 2022") )
```

### Salario por comunidades autónomas
```{r}
Salario_2021 <- tabla_final %>% 
  filter(years == 2021) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      )))


CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Salario_2021, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

X11()
Salario_21_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = Total_s),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = Total_s),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Greens", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$Total_s), 3000),
    guide = guide_legend(title = "Salario 2021")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))

#Salario 2022
library(ggplot2)
library(mapSpain)
library(sf)
Salario_2022 <- tabla_final %>% 
  filter(years == 2022) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      )))
CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Salario_2022, by = "ccaa.shortname.es")
Can <- esp_get_can_box()


Salario_22_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = Total_s),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = Total_s),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Purples", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$Total_s), 3000),
    guide = guide_legend(title = "Salario 2022")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))


# Combianción de gráficos:

library(cowplot)

Salario_21_22 <- plot_grid(Salario_21_graf, Salario_22_graf, ncols = 2, labels = c("SALARIO 2021", "SALARIO 2022") )

```

### Objetivos

- __Cantidad de psicólogos por Comunidad Autónoma en función de su población__
- __Asistencia en el área de salud mental segín sexo,edad y salario medio__

## Materiales
URLs de los distintos datos usados:

-[números de psicólogos](https://datos.gob.es/es/catalogo/ea0010587-distribucion-del-n-de-psicologos-por-comunidades-y-ciudades-autonomas-de-colegiacion-situacion-laboral-y-sexo-identificador-api-tpx-sociedad_2589-salud_2590-epsc_5623-a2022_9766-l0-s05005-px)

-[Ganancia anual sexo y edad](https://datos.gob.es/es/catalogo/ea0010587-sexo-y-edad-anual-nacional-encuesta-anual-de-estructura-salarial-identificador-api-281891)

-[Asistencia a profesionales del área mental](https://datos.gob.es/es/catalogo/ea0010587-visitas-a-otros-profesionales-sanitarios-en-los-ultimos-12-meses-segun-tipo-de-profesional-sanitario-por-sexo-y-comunidad-autonoma-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p02-l0-01050-px1)

-[Variación anual de la población](https://datos.gob.es/es/catalogo/ea0010587-variacion-anual-en-la-poblacion-por-comunidades-y-ciudades-autonomas-dpop-identificador-api-2920)



This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(climaemet)
aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqYWExMDE4QGFsdS51YnUuZXMiLCJqdGkiOiJkZTE4NmIwZC02ZTc1LTRmYmYtOGE4ZS1kYThiNzhkYjM5NWYiLCJpc3MiOiJBRU1FVCIsImlhdCI6MTY5OTI2NzY1NywidXNlcklkIjoiZGUxODZiMGQtNmU3NS00ZmJmLThhOGUtZGE4Yjc4ZGIzOTVmIiwicm9sZSI6IiJ9.Im8N73nz9TkoDv1I7_fmIf7FSgfyQGsTrwuYGrl3k9g", install = TRUE)
```

```{r}
library(tibble)
stations <- aemet_stations()
stations
```
```{r}
table(stations$provincia)
```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
