---
title: "Depresión y Jubilación"
author: "Lorena Calvo Pérez, Julia Arellano Atienza, Mario Díaz Sutil"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción
La necesidada de atención psicológica es definida como la demanda de servicios o intervenciones psicológicas que una persona puede tener debido a problemas emocionales, mentales o de comportamiento.

Esta necesidad puede surgir a partir de una variedad de situaciones y condiciones, y la atención psicológica puede ser buscada para abordar problemas como el estrés, la ansiedad, la depresión, los trastornos del estado de ánimo, las dificultades en las relaciones, traumas, entre otros.

En este caso nos centraremos en estudiar como diferentes factores como el salario o la temperatura media afecta a la NAT.

Para medir la necesidad de atención psiscológica utilizamos el numero de visitas al psicólogo, la disponibillidad de psicólogos y la población.
 
 
 La Necesidad de atención psicológica se calcula con la siguiente fórmula:
 \text{NAT} = \frac{\text{Visitas}}{\text{Psicólogos} \times \text{Población}} \times 100,000


## Objetivos

Los objetivos planteados para desarrollar el seminario son los siguientes:
 
  1. Visualizar la necesidad de atención psicológica por Comunidades Autónomas
  2. Estudiar como afecta la temperatura sobre la necesidad de atención psicológica 
  3. Estudiar como afecta  el salario sobre la necesidad de atención psicológica 
  
## Información sobre el tema

 
# Materiales y Métodos

## Materiales
URLs de los distintos datos usados:

-[Psicologos_2021](https://datos.gob.es/es/catalogo/ea0010587-distribucion-del-n-de-psicologos-por-comunidades-y-ciudades-autonomas-de-colegiacion-situacion-laboral-y-sexo-identificador-api-tpx-sociedad_2589-salud_2590-epsc_5623-a2021_8678-l0-s05005-px1)

[psicologos_2022](https://datos.gob.es/es/catalogo/ea0010587-distribucion-del-n-de-psicologos-por-comunidades-y-ciudades-autonomas-de-colegiacion-situacion-laboral-y-sexo-identificador-api-tpx-sociedad_2589-salud_2590-epsc_5623-a2022_9766-l0-s05005-px)


-[Población](https://datos.gob.es/es/catalogo/ea0010587-poblacion-por-nacionalidad-sexo-y-comunidad-autonoma-epa-identificador-api-4927)

-[Visitas_2021](https://datos.gob.es/es/catalogo/ea0010587-visitas-a-otros-profesionales-sanitarios-en-los-ultimos-12-meses-segun-tipo-de-profesional-sanitario-por-sexo-y-comunidad-autonoma-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p02-l0-01050-px1)

-[Visitas_2022](https://datos.gob.es/es/catalogo/ea0010587-visitas-a-otros-profesionales-sanitarios-en-los-ultimos-12-meses-segun-tipo-de-profesional-sanitario-por-sexo-y-comunidad-autonoma-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p05-l0-01038-px1)

- [Salarios](https://datos.gob.es/es/catalogo/ea0010587-salarios-medios-por-tipo-de-jornada-comunidad-autonoma-y-decil-epa-identificador-api-13930)
 
## Carga de librerías
```{r}
library(climaemet)
library(tibble)
library(tidyverse)
library(rjson)
library(tidyjson)
library(readr)
library(ggplot2)
library(mapSpain)
library(sf)
library(cowplot)
library(visreg)
library(DT)
```

## Acceso a climaemet

API necesaria para poder acceder a los datos de climaemet.

```{r}
library(climaemet)
aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqYWExMDE4QGFsdS51YnUuZXMiLCJqdGkiOiJkZTE4NmIwZC02ZTc1LTRmYmYtOGE4ZS1kYThiNzhkYjM5NWYiLCJpc3MiOiJBRU1FVCIsImlhdCI6MTY5OTI2NzY1NywidXNlcklkIjoiZGUxODZiMGQtNmU3NS00ZmJmLThhOGUtZGE4Yjc4ZGIzOTVmIiwicm9sZSI6IiJ9.Im8N73nz9TkoDv1I7_fmIf7FSgfyQGsTrwuYGrl3k9g", install = TRUE)
```

Podemos ver las estaciones meteorológicas de las que dipsone climaemet de datos y las localizaciones de dichas estaciones en las provinvias.

```{r}
library(tibble)
stations <- aemet_stations()
stations
```
```{r}
table(stations$provincia)
```

## Carga de datos

### Carga de datos de climaemet
```{r}
# Obtención de las Tª diaras por estaciones aemet:

observaciones_diarias <-aemet_daily_period_all(start = 2021, end = 2022)
```

### Carga de datos JSON
```{r eval=FALSE}

#Carga de datos de la población json no coindiden los atributos 

poblacion_json <- fromJSON(file ="DATA/poblacion.json")

poblacion_json %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

poblacion_Data<- poblacion_json %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() 
 

poblacion_MetaData<- poblacion_json %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all()

poblacion_json_union<- cbind(poblacion_Metadata,poblacion_Data)

#CARGA de datos psicologos.json 

psicologos_json_2021 <- fromJSON(file ="DATA/tasa_psicologos_2021.json")

#Identificacion de arrays

psicologos_json_2021 %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

#obtenemos la columna data

psicologos_json_2021_Data<- psicologos_json_2021 %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(Valor)

#obtenemos la columna metadata

psicologos_json_2021_Metadata<- psicologos_json_2021 %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(-document.id, - array.index)

#union de columnas

psicologos_json_2021_union<- cbind(psicologos_json_2021_Metadata,psicologos_json_2021_Data)

```

![Tabla_psicologos.json](IMAGES/tabla_psicologos.jpg)

![Tabla_psicologos.csv](IMAGES/tabla_psicologos_json.jpg)

Como se visualiza en las tablas, al intentar cargas los datos json nos encontrabamos 2 objetos de tipo arrays (Data y Metadata). En el objeto Data se localizaban los valores , miestras que en el objeto Metadata se localizaban las varibles.Hay combinar todo vemos que los final combinadas no son las correctas en consecuencia, que las variables no coinciden con sus valores.

En conclusión, utilizamos csv para cargar nuestros datos de forma correcta.

### Carga de datos csv

```{r}
# Carga csv de psicologos

psicologos_2021 <- read_delim("DATA/psicologos2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


psicologos_2022 <- read_delim("DATA/psicologos2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga csv de visitas

visitas_2021 <- read_delim("DATA/visitas_2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

visitas_2022 <- read_delim("DATA/visitas_2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga de datos Población.csv

poblacion <- read_delim("DATA/poblacion_CA_años.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


# Carga de datos de salarios .csv:

salarios <- read_delim("DATA/salarios_CCAA.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

## Trabajando con los datos

### Obtención de la Temperatura Media

*Nota:* Temperatura media por Comunidades Autónomas


Para la obtención de la *temperatura media*, se han creado una columna de años y y otra columna de comunidades.Esta última se utilizó para agrupar los datos mostrados en provincias en comunidades.
Tras ello, hemos calculado la temperatura media por comunidad.
```{r}

# Temperatura de las provincias
temp_provincias <-  observaciones_diarias %>%
  mutate(years=lubridate::year(fecha))%>%
  group_by (years,provincia) %>%
  summarise(
    tmedia = mean(tmed, na.rm = TRUE)
  )

# Creacion de una columna con las comunidades autonomas
  temp_con_CCAA <- temp_provincias %>%
  mutate(CCAA = case_when(
    provincia %in% c("BURGOS", "AVILA", "LEON", "SALAMANCA", "SEGOVIA", "SORIA", "VALLADOLID" ,"PALENCIA" ,"ZAMORA") ~ "CASTILLA Y LEON",
    provincia %in% c("ALBACETE", "CIUDAD REAL", "CUENCA", "GUADALAJARA", "TOLEDO") ~ "CASTILLA-LA MANCHA",
    provincia %in% c("ALMERIA", "CADIZ", "CORDOBA", "GRANADA", "HUELVA", "JAEN", "MALAGA", "SEVILLA") ~ "ANDALUCIA",
    provincia %in% c("HUESCA", "ZARAGOZA", "TERUEL") ~ "ARAGON",
    provincia == "ASTURIAS" ~ "ASTURIAS",
    provincia == "CANTABRIA" ~ "CANTABRIA",
    provincia == "ILLES BALEARS" ~ "BALEARES",
    provincia %in% c("STA. CRUZ DE TENERIFE", "LAS PALMAS") ~ "CANARIAS",
    provincia == "LA RIOJA" ~ "LA RIOJA",
    provincia %in% c("ARABA/ALAVA", "GIPUZKOA", "BIZKAIA") ~ "PAIS VASCO",
    provincia %in% c("BARCELONA", "GIRONA", "LLEIDA", "TARRAGONA") ~ "CATALUÑA", 
    provincia %in% c("ALICANTE", "CASTELLON", "VALENCIA") ~ "COMUNIDAD VALENCIANA",
    provincia %in% c("BADAJOZ", "CACERES") ~ "EXTREMADURA",
    provincia %in% c("A CORUÑA", "LUGO", "OURENSE", "PONTEVEDRA") ~ "GALICIA", 
    provincia == "MADRID" ~ "COMUNIDAD DE MADRID",
    provincia == "MURCIA" ~ "MURCIA",
    provincia == "NAVARRA" ~ "NAVARRA",
    provincia == "CEUTA" ~ "CEUTA",
    provincia == "MELILLA" ~ "MELILLA",
    
  ))

# TABLA FINAL Tª
tmed_CCAA<- temp_con_CCAA %>% 
  group_by(CCAA,years) %>% 
  summarise(
  tmedia = mean(tmedia, na.rm = TRUE)) %>% 
  arrange(years)

datatable(tmed_CCAA)
  
```
 
### Obtención de los psicólogos

*Nota:* Nº de psicólogos por Comunidades Autónomas

Los datos de *psicólogos* utilizados se encontraban en distintos conjuntos de datos.Inicialmente, se creo una columna CCAA en cada uno de los conjuntos para estandarizar los nombres de las comunidades autónomas.
Tras ello, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

```{r}

psicologos_2021 <- psicologos_2021 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                               levels = c("01 Andalucía", "02 Aragón", 
                                          "03 Asturias, Principado de", "04 Balears, Illes", 
                                          "05 Canarias", 
                                          "06 Cantabria", 
                                          "07 Castilla y León", "08 Castilla - La Mancha",
                                          "09 Cataluña", "10 Comunitat Valenciana",
                                          "11 Extremadura", "12 Galicia", 
                                          "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                          "15 Navarra, Comunidad Foral de",
                                          "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                          "19 Melilla"), 
                               labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA")))



psicologos_2022 <- psicologos_2022 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                       levels = c("Andalucía", "Aragón", 
                                                  "Asturias, Principado de", "Balears, Illes", 
                                                  "Canarias", 
                                                  "Cantabria", 
                                                  "Castilla-La Mancha", "Castilla y León",
                                                  "Cataluña", "Ceuta", "Comunidad Valenciana",
                                                  "Extremadura", "Galicia", 
                                                  "Madrid, Comunidad de", "Melilla", "Murcia, Región de",
                                                  "Navarra, Comunidad Foral de",
                                                  "País Vasco", "Rioja, La" 
                                                  ), 
                                       labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                  "BALEARES", "CANARIAS", "CANTABRIA", 
                                                  "CASTILLA-LA MANCHA", "CASTILLA Y LEON", "CATALUÑA", 
                                                  "CEUTA", "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                  "GALICIA", "COMUNIDAD DE MADRID", "MELILLA", "MURCIA",
                                                  "NAVARRA", "PAIS VASCO", "LA RIOJA")))


# Psicologos completos

psicologos <- psicologos_2021 %>%
  mutate(years = 2021) %>% 
  full_join(., 
            psicologos_2022 %>%
              mutate(years = 2022) ) %>% 
  drop_na() %>% 
  filter(`Situación laboral`== "Colegiados no jubilados") %>% 
  group_by(CCAA, years) %>%
  mutate(Total_ind_ps=Total/10^5) %>%
  select(Total_ind_ps)
# La columan de Total_ps está en formato numérico 

datatable(psicologos)

```

### Obtención de las visitas

*Nota:* Nº de visitas por Comunidades Autónomas

Los datos de **visitas** utilizados se encontraban en distintos conjuntos de datos.Inicialmente, se creo una columna CCAA en cada uno de los conjuntos para estandarizar los nombres de las comunidades autónomas.
Tras ello, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

```{r}
visitas_2021 <- visitas_2021 %>% 
  mutate(Total_v = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))

visitas_2022 <- visitas_2022 %>% 
  mutate(Total_v = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))


levels(factor(visitas_2021$`Comunidades y Ciudades Autónomas`))
levels(factor(visitas_2022$`Comunidades y Ciudades Autónomas`))

visitas_2021 <- visitas_2021 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                                     levels = c("Andalucía", "Aragón", 
                                                                "Asturias (Principado de)", "Balears (Illes)", 
                                                                "Canarias", 
                                                                "Cantabria", 
                                                                "Castilla-La Mancha", "Castilla y León",
                                                                "Cataluña", "Ceuta (Ciudad Autónoma de)", 
                                                                "Comunitat Valenciana",
                                                                "Extremadura", "Galicia", 
                                                                "Madrid (Comunidad de)", 
                                                                "Melilla (Ciudad Autónoma de)", "Murcia (Región de)",
                                                                "Navarra (Comunidad Foral de)",
                                                                "País Vasco", "Rioja (La)" 
                                                     ), 
                                                     labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                                "BALEARES", "CANARIAS", "CANTABRIA", 
                                                                "CASTILLA-LA MANCHA", "CASTILLA Y LEON", "CATALUÑA", 
                                                                "CEUTA", "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                                "GALICIA", "COMUNIDAD DE MADRID", "MELILLA", "MURCIA",
                                                                "NAVARRA", "PAIS VASCO", "LA RIOJA")))


visitas_2022 <- visitas_2022 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                             levels = c("01 Andalucía", "02 Aragón", 
                                        "03 Asturias, Principado de", "04 Balears, Illes", 
                                        "05 Canarias", 
                                        "06 Cantabria", 
                                        "07 Castilla y León", "08 Castilla - La Mancha",
                                        "09 Cataluña", "10 Comunitat Valenciana",
                                        "11 Extremadura", "12 Galicia", 
                                        "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                        "15 Navarra, Comunidad Foral de",
                                        "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                        "19 Melilla"), 
                             labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                        "BALEARES", "CANARIAS", "CANTABRIA", 
                                        "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                        "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                        "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                        "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA")))

#Visitas finales
visitas<- visitas_2021%>%
  mutate(years = 2021) %>% 
  full_join(., 
            visitas_2022%>%
              mutate(years = 2022) ) %>% 
  drop_na() %>% 
  filter(`Tipo de profesional` == "Psicólogo, psicoterapeuta o psiquiatra" & 
           `Sí o no` == "Sí" & Sexo == "Ambos sexos") %>% 
  group_by(CCAA, years) %>% 
  select(Total_v)

datatable(visitas)

```


### Obtención del salario

*Nota:* Salarios mensuales por Comunidades Autónomas

Para la obtención de los datos de *salario* utilizados.Se crean una columna para transformar los salarios de tipo __character__ a tipo __númerico__.
Tras ello, se creo una columna CCAA para estandarizar los nombres de las comunidades autónomas.Además, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

```{r}
salarios <- salarios %>% 
  mutate(Total_s = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))


# Es necesario aplicar un mutate sobre salarios para que tenga los mismos levels que el resto de tablas
salarios <- salarios %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autonómas`, 
                                                 levels = c("01 Andalucía", "02 Aragón", 
                                                            "03 Asturias, Principado de", "04 Balears, Illes", 
                                                            "05 Canarias", 
                                                            "06 Cantabria", 
                                                            "07 Castilla y León", "08 Castilla - La Mancha",
                                                            "09 Cataluña", "10 Comunitat Valenciana",
                                                            "11 Extremadura", "12 Galicia", 
                                                            "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                                            "15 Navarra, Comunidad Foral de",
                                                            "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                                            "19 Melilla", "Total Nacional"), 
                                                 labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                            "BALEARES", "CANARIAS", "CANTABRIA", 
                                                            "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                                            "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                            "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                                            "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA",
                                                            "TOTAL NACIONAL")))

levels(factor(salarios$CCAA))

# Salarios completos

salarios_final <- salarios %>%
  drop_na() %>% 
  rename(years = Periodo)%>% 
  filter(`Tipo de jornada` == "Total" & 
           Decil == "Total decil" &
           years %in% c(2021,2022) &
           CCAA != "TOTAL NACIONAL" ) %>% 
  group_by(CCAA, years) %>% 
  select(Total_s) %>% 
  arrange(years)

datatable(salarios_final)
```


### Obtención de la población

*Nota:* Población por Comunidades Autónomas

Para la obtención de los datos de *población * utilizados.Se crean una columna para transformar la población de tipo __character__ a tipo __númerico__.
Tras ello, se creo una columna CCAA para estandarizar los nombres de las comunidades autónomas.Además, se combinaron los conjutos y se seleccionaron aquellos útiles para el estudio.

```{r}
poblacion <- poblacion %>% 
  mutate(Total_pob = as.numeric(gsub(',', '.', gsub('\\.', '', .$Total))))



# Es necesario aplicar un mutate sobre poblacion para que tenga los mismos levels que el resto de tablas: 
poblacion <- poblacion %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                               levels = c("01 Andalucía", "02 Aragón", 
                                                          "03 Asturias, Principado de", "04 Balears, Illes", 
                                                          "05 Canarias", 
                                                          "06 Cantabria", 
                                                          "07 Castilla y León", "08 Castilla - La Mancha",
                                                          "09 Cataluña", "10 Comunitat Valenciana",
                                                          "11 Extremadura", "12 Galicia", 
                                                          "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                                          "15 Navarra, Comunidad Foral de",
                                                          "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                                          "19 Melilla", "Total Nacional"), 
                                               labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA",
                                                          "TOTAL NACIONAL")))


#Población completa

poblacion_final <- poblacion %>%
  drop_na() %>% 
  rename(years=Periodo)%>% 
  filter(Sexo == "Ambos sexos" & 
           Nacionalidad == "Total" &
           years %in% c(2021,2022) &
           CCAA != "TOTAL NACIONAL" ) %>% 
  group_by(CCAA,years) %>% 
  select(Total_pob) %>% 
  arrange(years)

datatable(poblacion_final)
```


## Obtención de la tabla final

A través de la unión de las diferentes tablas obtenidas (tmed_CCAA,salarios_final,poblacion_final y psicologos) mediante los atributos comunes, el 'CCAA' y 'years' , construimos la tabla final con los datos de interés.
Por otro lado, hemos creado un total de 3 columnas nuevas,las cuales son:
    - **iniciales_CCAA** : contiene las abreviaturas para identificar a las CCAA.
    - **Total_ps** : contiene la cantidad de psicologos por cada CCAA.
    - **NAT** : contiene los valores de la necesidad de atención psicológica por cada         comunidad.
    
```{r}

# OBTENCIÓN DE LA TABLA FINAL:
tabla_final<- tmed_CCAA %>% 
              full_join(.,salarios_final) %>% 
              full_join(.,psicologos) %>% 
              full_join(.,poblacion_final) %>% 
          mutate(.,Total_ps=Total_ind_ps*(Total_pob*10^3)) %>%
              full_join(.,visitas) %>% 
          mutate(.,NAT=as.integer(Total_v*10^6/(Total_ps*(Total_pob*10^3))*10^5)) %>% 
          mutate(.,iniciales_CCAA = factor(CCAA,
                                   levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                            "BALEARES", "CANARIAS", "CANTABRIA", 
                                            "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                            "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                            "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                            "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                   labels = c("An","Ar","As","Bl","Cs","Ca","CyL","Cm","Ct","Cv","Ex",
                                              "Ga","M","Mu","Na","Pv","R","Ce","Ml" ))) %>% 
          select(.,iniciales_CCAA,everything())

datatable(tabla_final)
```

# Análisis de nuestros datos

## Gráficos

### **Visualización del salario medio en España por CCAA**

A continuación se pueden observar los salarios medios entre las diferentes CCAA, tanto en 2021 como 2022.

```{r}
#SALARIO 2021

Salario_2021 <- tabla_final %>% 
  filter(years == 2021) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      )))


CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Salario_2021, by = "ccaa.shortname.es")
Can <- esp_get_can_box()


Salario_21_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = Total_s),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = Total_s),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Greens", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$Total_s), 3000),
    guide = guide_legend(title = "Salario 2021")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))

#Salario 2022

Salario_2022 <- tabla_final %>% 
  filter(years == 2022) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      )))
CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Salario_2022, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

Salario_22_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = Total_s),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = Total_s),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Purples", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$Total_s), 3000),
    guide = guide_legend(title = "Salario 2022")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))


# Gráficos combinados:

Salario_21_22 <- plot_grid(Salario_21_graf, Salario_22_graf, ncols = 2, labels = c("SALARIO 2021", "SALARIO 2022") )

Salario_21_22

```

### Conclusiones

Se puede apreciar una notable diferencia de los salarios entre un año y otro, siendo superiores los salarios de 2022.Por otro lado se observa un patrón de salarios en el cual  Madrid, EL País Vasco, Navarra y Cataluña contienen en ambos años salafrios superiores al resto de España.


### **Visualización de la temperatura media en España por CCAA**

A continuación se puede observar la temperatura media entre las diferentes CCAA, tanto en 2021 como 2022.

```{r}
# Temperatura 

#Temperatura 2021

Temperatura_2021 <- tabla_final %>% 
  filter(years == 2021) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      ))) %>% 
  mutate(., tmedia = round(tmedia, 3))


CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Temperatura_2021, by = "ccaa.shortname.es")
Can <- esp_get_can_box()


Temperatura_21_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = tmedia),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = tmedia),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Oranges", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$tmedia), 21),
    guide = guide_legend(title = "Temperatura 2021")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))

#Temperatura 2022


Temperatura_2022 <- tabla_final %>% 
  filter(years == 2022) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      ))) %>% 
  mutate(., tmedia = round(tmedia, 3))

CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, Temperatura_2022, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

Temperatura_22_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = tmedia),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = tmedia),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Reds", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$tmedia), 22),
    guide = guide_legend(title = "Temperatura 2022")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))


# Gráficos combinados:

Temperatura_21_22 <- plot_grid(Temperatura_21_graf, Temperatura_22_graf, ncols = 2, labels = c("TEMPERATURA 2021", "TEMPERATURA 2022") )

Temperatura_21_22

```

### Conclusiones

Se puede apreciar en zonas como el sur peninsular y las CCAA de la zona mediterránea presentan una mayor temperatura media que las zonas del Norte.
Por otro lado la difernecia observada entre 2021 y 2022, es que se ha producido una subida de temperatura de 1 grado en toda España.

## **Gráficos de dispersión**

### **NAT vs Temperatura media**

En este gráfico de dispersión vamos a visulizar como afecta la temperatura media de cada una de las CCAA en la necesidad de atención psicológica.

```{r}

NAT_vs_tmedia <- tabla_final %>%
          filter(.,NAT<50000) %>% 
          ggplot(.,mapping=aes(x=tmedia,y=NAT))+
          geom_point(aes(colour=factor(years),shape=factor(years)))+ 
          geom_smooth()+
          labs(x="Temperatura Media(ºC)",y="Necesidad de Atención Psicológica",
               subtitle = "Relación entre la Temperatura Media y la NAT")+
          theme_bw()

NAT_vs_tmedia

```

### Conclusiones

De forma general se aprecia que a partir de una temperatura media superior a 18ºC, comienza a crecer de forma exponencial la necesidad de atención psicológica.
Análogamente, podemos ver que ante valores de temperatura inferiores a 15ºC también se observa un ligero aumento de la NAT, pero mucho más suavizada.

Por otro lado, ante unos valores de temperatura intermedios (menos extremos) la NAT disminuye, manteniéndose aproxiamdamente en un valor constante.

En general, en el 2021 hubo una mayor necesidad de atención psicológica que en 2022 y esto pudo deberse a la post-pandemia.
Podemos llegar a la conclusion de que mayores temperaturas pueden ocasionar mayor cantidad de estrés y con ello mayor NAT.

### **NAT vs salario**

En este gráfico de dispersión vamos a visulizar como afecta el salario medio de cada una de las CCAA en la necesidad de atención psicológica.

```{r}

NAT_vs_salario <- tabla_final %>% 
  filter(.,NAT<50000) %>% 
  ggplot(.,mapping=aes(x=Total_s,y=NAT))+
  geom_point(aes(colour=factor(years),shape=factor(years)))+ 
  geom_smooth()+
  labs(x="Salario",y="Necesidad de Atención Psicológica",
       subtitle = "Relación entre el salario y la NAT")+
  theme_bw()

NAT_vs_salario

```

### Conclusiones

Ante valores bajos de salario, la NAT no es muy elevada, probablemente debido a que dicho salario no es destinado para esa necesidad .
Podemos determinar que para el mismo rango de salarios, la NAT es superior en 2021 que en 2022.

Por otro lado, conforme aumenta el salario ,hasta 2200€, aumenta el valor de la NAT paulatinamente.

De forma muy clara, se observa que ante salarios más elevados (a partir de 2200€) la NAT disminuye, llegando incluso a ser nula.

## Gráfico de barras

### NAT VS CCAA

En este gráfico de dispersión vamos a visulizar como afecta el salario medio de cada una de las CCAA en la necesidad de atención psicológica.

```{r}
NAT_vs_CCAA <- tabla_final %>% 
  ggplot(., aes(x = reorder(iniciales_CCAA, desc(NAT)), y = NAT, fill = factor(years))) +
  geom_bar(stat = "identity", color = "black") +
  labs(
    title = "NAT por Comunidad Autónoma",
    x = "Comunidad Autónoma",
    y = "Necesidad de Atención Psicológica"
  ) +
  theme_gray() +
  facet_wrap(facets = vars(years), nrow = 1)

NAT_vs_CCAA

```

### Conclusiones 

Podemos aprecir que los valores de NAT han sido más elevados generalemnte en 2021 que en 2022.
Al igual que la CCAA con más NAT ha sido tanto en 2021 como en 2022 Ceuta y detrás de esta Melilla.
La CCAA siguen la misma tendencia de NAT en ambos años, pero con valores generalemnte inferiores 



## **Visualización de la NAT en cada CCAA de España**

A continuación se puede observar la necesidad de atención psicológica entre las diferentes CCAA, tanto en 2021 como 2022.
```{r}

# NAT 2021
NAT_2021 <- tabla_final %>% 
  filter(years == 2021) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                 levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                 labels = c("Andalucía", "Aragón", 
                                            "Asturias", "Baleares ", 
                                            "Canarias", 
                                            "Cantabria", 
                                            "Castilla y León","Castilla-La Mancha",
                                            "Cataluña", "Comunidad Valenciana",
                                            "Extremadura", "Galicia", 
                                            "Madrid", "Murcia",
                                            "Navarra",
                                            "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                )))


CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, NAT_2021, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

NAT_21_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = NAT),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = NAT),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Blues", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$NAT), 13000),
    guide = guide_legend(title = "NAT 2021")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))

# NAT 2022

NAT_2022 <- tabla_final %>% 
  filter(years == 2022) %>% 
  mutate(.,ccaa.shortname.es = factor(CCAA,
                                      levels=c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                               "BALEARES", "CANARIAS", "CANTABRIA", 
                                               "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                               "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                               "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                               "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA"), 
                                      labels = c("Andalucía", "Aragón", 
                                                 "Asturias", "Baleares ", 
                                                 "Canarias", 
                                                 "Cantabria", 
                                                 "Castilla y León","Castilla-La Mancha",
                                                 "Cataluña", "Comunidad Valenciana",
                                                 "Extremadura", "Galicia", 
                                                 "Madrid", "Murcia",
                                                 "Navarra",
                                                 "País Vasco", "La Rioja" ,"Ceuta","Melilla"
                                      )))
CCAA_sf <- esp_get_ccaa()
CCAA_sf <- merge(CCAA_sf, NAT_2022, by = "ccaa.shortname.es")
Can <- esp_get_can_box()

NAT_22_graf <- ggplot(CCAA_sf) +
  geom_sf(aes(fill = NAT),
          color = "black",
          linewidth = .3
  ) +
  geom_sf(data = Can, color = "black") +
  geom_sf_label(aes(label = NAT),
                fill = "white", alpha = 0.5,
                size = 3,
                label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(7, "Reds", rev = TRUE),
    n.breaks = 7,
    labels = function(x) sprintf("%1.0f", x),
    limits = c(min(CCAA_sf$NAT), 5000),
    guide = guide_legend(title = "NAT 2022")
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6))


# Gráficos combinados:
library(cowplot)
X11()
NAT_21_22 <- plot_grid(NAT_21_graf, NAT_22_graf, ncols = 2, labels = c("NAT 2021", "NAT 2022") )

NAT_21_22

```

### Conclusiones

En 2021, podemos apreciar que en las zonas del norte y centro peninsular, así como Ceuta y Melilla, la NAT es más elevada que en el resto de las CCAA.
En 2022, generalmente los valores de NAT son más bajo, exluyendo algunas CCAA como La Rioja, Cantabria, Navarra, Ceuta y Melilla.

En conclusión, podemos determiar que en el 2021 hay mucha más NAT que en el 2022, esto puede ser debido a la post-pandemia, salarios inferiores, temperaturas mas bajas.


## **Análisis de la regresión lineal**

Procedemos a crear un modelo lineal donde la variable de respuesta es **'NAT'** (necesidad de atención psicológica) y las variables predictoras son **'tmedia'** (temperatura media) y **'Total_s'** (salario medio). También, analizaremos la interacción entre **'tmedia'** y **'Total_s'**

Este modelo (**'Modelo'**) es ajustado utilizando la tabla final (**'tabla_final'**).

```{r}
Modelo <- lm(NAT ~ tmedia*Total_s, data = tabla_final)
summary(Modelo)
```

- **COEFICIENTES**:

  - **Intercept**: Es 774516.902. Valor estimado de la variable de respuesta (NAT) cuando todas las variables predictoras son cero.

  - **tmedia**: Por cada unidad de **aumento** en **tmedia**, se espera que la NAT disminuya en promedio en -51551.784 unidades.
            Sin embargo, en gráficas anteriores hemos visto como ante un mayor valor de temperatura la NAT aumentaba exponencialmente (la conclusión del análisis no se corresponde con el comportamiento del modelo).

  - **Total_s**: Por cada unidad de **aumento** en **Total_s**, se espera que NAT disminuya en promedio en -397.301 unidades. Se corresponde con el comportamiento observado del modelo. 

  - **Interacción entre tmedia y Total_s**: Es positiva (26.668). Esto indica que el efecto de tmedia en NAT depende del valor de Total_s, y viceversa.
  
- **SIGNIFICACIÓN ESTADÍSTICA**:

Los **asteriscos** en la *columna "Pr(>|t|)"* indican la **significancia estadística** de cada coeficiente. 
Podemos observar como el intercept, tmedia, Total_s y su interacción son **estadísticamente significativas**, dado que presentan unos valores p < 0.05.


- **BONDAD DE AJUSTE**:
  - **Residual standard error**: La desviación estándar de los residuos (errores) es 20450. Esto indica la variabilidad no explicada por el modelo.

  - **R cuadrado y R cuadrado ajustado**: El *R cuadrado* es 0.3869, lo que significa que el modelo explica el 38.69% de la variabilidad en NAT. El *R cuadrado ajustado* tiene en cuenta el número de predictores en el modelo, y es 0.3328.


- **ESTADÍSITCO F**:

El valor F-statistic (7.151) y el p-value asociado (0.000754) indican si al menos una de las variables predictoras es significativa en la explicación de la variabilidad en la variable de respuesta. 
En este caso, el p-value es bajo, lo que sugiere que al menos una de las variables predictoras (tmedia y Total_s) es significativa en el modelo.

Como hemos observado en las diversas gráficas, ambas variables tienen un efecto sobre la NAT. 


En resumen, el modelo proporciona evidencia de que las variables **tmedia**, **Total_s** y su **interacción** tienen un **impacto significativo** en la variable de **respuesta NAT**. 
Sin embargo, el modelo solo explica alrededor del 38.69% de la variabilidad en NAT, lo que sugiere que hay otras variables que podrían estar influyendo en la respuesta.


### **Visualización 3D para ver la relación entre Tª media y el total de salario**

A continuación, podremos observar la relación conjunta entre **tmedia** y **Total_s** sobre la NAT de nuestro modelo lineal. 
Podemos ver cómo cambia la **NAT** ante las variables predictoras **tmedia** y **Total_s**.

```{r}

visor_3d <- visreg2d(Modelo, "tmedia", "Total_s", plot.type = "rgl")

visor_3d
```
