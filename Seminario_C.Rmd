---
title: "Depresión y Jubilación"
author: "Lorena Calvo Pérez, Julia Arellano Atienza, Mario Díaz Sutil"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción
 Se va a estudiar la relación que hay entre la asistencia al ámbito de salud mental con la economía de la población, en función de las comunidades.
 
# Materiales y Métodos
 
## Carga de librerías
```{r}
library(climaemet)
library(tibble)
library(tidyverse)
library(rjson)
library(tidyjson)
library(readr)
library(ggplot2)
library(mapSpain)
library(sf)
library(cowplot)
library(visreg)
library(DT)
```
## Carga de datos
### Carga de datos de climaemet
```{r}
# Obtención de las Tª diaras por estaciones aemet:

observaciones_diarias <-aemet_daily_period_all(start = 2021, end = 2022)
```

### Carga de datos JSON
```{r eval=FALSE}

#Carga de datos de la población json no coindiden los atributos 

poblacion_json <- fromJSON(file ="DATA/poblacion.json")

poblacion_json %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

poblacion_Data<- poblacion_json %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() 
 

poblacion_MetaData<- poblacion_json %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all()

poblacion_json_union<- cbind(poblacion_Metadata,poblacion_Data)

#CARGA de datos psicologos.json 

psicologos_json_2021 <- fromJSON(file ="DATA/tasa_psicologos_2021.json")

#Identificacion de arrays

psicologos_json_2021 %>% 
  spread_all() %>% 
  gather_object() %>% 
  json_types() %>% 
  count(name, type)

#obtenemos la columna data

psicologos_json_2021_Data<- psicologos_json_2021 %>% 
  enter_object(Data) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(Valor)

#obtenemos la columna metadata

psicologos_json_2021_Metadata<- psicologos_json_2021 %>% 
  enter_object(MetaData) %>% 
  gather_array() %>% 
  spread_all() %>%
  select(-document.id, - array.index)

#union de columnas

psicologos_json_2021_union<- cbind(psicologos_json_2021_Metadata,psicologos_json_2021_Data)


```

### Carga de datos csv
```{r}
# Carga csv de psicologos

psicologos_2021 <- read_delim("DATA/psicologos2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


psicologos_2022 <- read_delim("DATA/psicologos2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga csv de visitas

visitas_2021 <- read_delim("DATA/visitas_2021.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

visitas_2022 <- read_delim("DATA/visitas_2022.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

# Carga de datos Población.csv

poblacion <- read_delim("DATA/poblacion_CA_años.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)


# Carga de datos de salarios .csv:

salarios <- read_delim("DATA/salarios_CCAA.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE)

```

## Trabajando con los datos

### Obtención de la Temperatura Media

```{r}

# Temperatura de las provincias
temp_provincias <-  observaciones_diarias %>%
  mutate(years=lubridate::year(fecha))%>%
  group_by (years,provincia) %>%
  summarise(
    tmedia = mean(tmed, na.rm = TRUE)
  )

# Creacion de una columna con las comunidades autonomas
  temp_con_CCAA <- temp_provincias %>%
  mutate(CCAA = case_when(
    provincia %in% c("BURGOS", "AVILA", "LEON", "SALAMANCA", "SEGOVIA", "SORIA", "VALLADOLID" ,"PALENCIA" ,"ZAMORA") ~ "CASTILLA Y LEON",
    provincia %in% c("ALBACETE", "CIUDAD REAL", "CUENCA", "GUADALAJARA", "TOLEDO") ~ "CASTILLA-LA MANCHA",
    provincia %in% c("ALMERIA", "CADIZ", "CORDOBA", "GRANADA", "HUELVA", "JAEN", "MALAGA", "SEVILLA") ~ "ANDALUCIA",
    provincia %in% c("HUESCA", "ZARAGOZA", "TERUEL") ~ "ARAGON",
    provincia == "ASTURIAS" ~ "ASTURIAS",
    provincia == "CANTABRIA" ~ "CANTABRIA",
    provincia == "ILLES BALEARS" ~ "BALEARES",
    provincia %in% c("STA. CRUZ DE TENERIFE", "LAS PALMAS") ~ "CANARIAS",
    provincia == "LA RIOJA" ~ "LA RIOJA",
    provincia %in% c("ARABA/ALAVA", "GIPUZKOA", "BIZKAIA") ~ "PAIS VASCO",
    provincia %in% c("BARCELONA", "GIRONA", "LLEIDA", "TARRAGONA") ~ "CATALUÑA", 
    provincia %in% c("ALICANTE", "CASTELLON", "VALENCIA") ~ "COMUNIDAD VALENCIANA",
    provincia %in% c("BADAJOZ", "CACERES") ~ "EXTREMADURA",
    provincia %in% c("A CORUÑA", "LUGO", "OURENSE", "PONTEVEDRA") ~ "GALICIA", 
    provincia == "MADRID" ~ "COMUNIDAD DE MADRID",
    provincia == "MURCIA" ~ "MURCIA",
    provincia == "NAVARRA" ~ "NAVARRA",
    provincia == "CEUTA" ~ "CEUTA",
    provincia == "MELILLA" ~ "MELILLA",
    
  ))

# TABLA FINAL Tª
tmed_CCAA<- temp_con_CCAA %>% 
  group_by(CCAA,years) %>% 
  summarise(
  tmedia = mean(tmedia, na.rm = TRUE)) %>% 
  arrange(years)

datatable(tmed_CCAA)
  
```

### Obtención de los psicólogos

```{r}

psicologos_2021 <- psicologos_2021 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                               levels = c("01 Andalucía", "02 Aragón", 
                                          "03 Asturias, Principado de", "04 Balears, Illes", 
                                          "05 Canarias", 
                                          "06 Cantabria", 
                                          "07 Castilla y León", "08 Castilla - La Mancha",
                                          "09 Cataluña", "10 Comunitat Valenciana",
                                          "11 Extremadura", "12 Galicia", 
                                          "13 Madrid, Comunidad de", "14 Murcia, Región de", 
                                          "15 Navarra, Comunidad Foral de",
                                          "16 País Vasco", "17 Rioja, La", "18 Ceuta", 
                                          "19 Melilla"), 
                               labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                          "BALEARES", "CANARIAS", "CANTABRIA", 
                                          "CASTILLA Y LEON", "CASTILLA-LA MANCHA", "CATALUÑA", 
                                          "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                          "GALICIA", "COMUNIDAD DE MADRID", "MURCIA",
                                          "NAVARRA", "PAIS VASCO", "LA RIOJA", "CEUTA", "MELILLA")))



psicologos_2022 <- psicologos_2022 %>% 
  mutate(CCAA = factor(`Comunidades y Ciudades Autónomas`, 
                                       levels = c("Andalucía", "Aragón", 
                                                  "Asturias, Principado de", "Balears, Illes", 
                                                  "Canarias", 
                                                  "Cantabria", 
                                                  "Castilla-La Mancha", "Castilla y León",
                                                  "Cataluña", "Ceuta", "Comunidad Valenciana",
                                                  "Extremadura", "Galicia", 
                                                  "Madrid, Comunidad de", "Melilla", "Murcia, Región de",
                                                  "Navarra, Comunidad Foral de",
                                                  "País Vasco", "Rioja, La" 
                                                  ), 
                                       labels = c("ANDALUCIA", "ARAGON", "ASTURIAS",
                                                  "BALEARES", "CANARIAS", "CANTABRIA", 
                                                  "CASTILLA-LA MANCHA", "CASTILLA Y LEON", "CATALUÑA", 
                                                  "CEUTA", "COMUNIDAD VALENCIANA", "EXTREMADURA",
                                                  "GALICIA", "COMUNIDAD DE MADRID", "MELILLA", "MURCIA",
                                                  "NAVARRA", "PAIS VASCO", "LA RIOJA")))


# Psicologos completos

psicologos <- psicologos_2021 %>%
  mutate(years = 2021) %>% 
  full_join(., 
            psicologos_2022 %>%
              mutate(years = 2022) ) %>% 
  drop_na() %>% 
  filter(`Situación laboral`== "Colegiados no jubilados") %>% 
  group_by(CCAA, years) %>%
  mutate(Total_ind_ps=Total/10^5) %>%
  select(Total_ind_ps)
# La columan de Total_ps está en formato numérico 

datatable(psicologos)

```

### Obtención de las visitas



### Objetivos
- __Cantidad de psicólogos por Comunidad Autónoma en función de su población__
- __Asistencia en el área de salud mental segín sexo,edad y salario medio__

## Materiales
URLs de los distintos datos usados:

-[números de psicólogos](https://datos.gob.es/es/catalogo/ea0010587-distribucion-del-n-de-psicologos-por-comunidades-y-ciudades-autonomas-de-colegiacion-situacion-laboral-y-sexo-identificador-api-tpx-sociedad_2589-salud_2590-epsc_5623-a2022_9766-l0-s05005-px)

-[Ganancia anual sexo y edad](https://datos.gob.es/es/catalogo/ea0010587-sexo-y-edad-anual-nacional-encuesta-anual-de-estructura-salarial-identificador-api-281891)

-[Asistencia a profesionales del área mental](https://datos.gob.es/es/catalogo/ea0010587-visitas-a-otros-profesionales-sanitarios-en-los-ultimos-12-meses-segun-tipo-de-profesional-sanitario-por-sexo-y-comunidad-autonoma-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p02-l0-01050-px1)

-[Variación anual de la población](https://datos.gob.es/es/catalogo/ea0010587-variacion-anual-en-la-poblacion-por-comunidades-y-ciudades-autonomas-dpop-identificador-api-2920)



This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(climaemet)
aemet_api_key("eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqYWExMDE4QGFsdS51YnUuZXMiLCJqdGkiOiJkZTE4NmIwZC02ZTc1LTRmYmYtOGE4ZS1kYThiNzhkYjM5NWYiLCJpc3MiOiJBRU1FVCIsImlhdCI6MTY5OTI2NzY1NywidXNlcklkIjoiZGUxODZiMGQtNmU3NS00ZmJmLThhOGUtZGE4Yjc4ZGIzOTVmIiwicm9sZSI6IiJ9.Im8N73nz9TkoDv1I7_fmIf7FSgfyQGsTrwuYGrl3k9g", install = TRUE)
```

```{r}
library(tibble)
stations <- aemet_stations()
stations
```
```{r}
table(stations$provincia)
```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
